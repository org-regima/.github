name: OrgimA Organization Introspection

on:
  schedule:
    - cron: '0 6 * * 1'  # Weekly on Monday at 6 AM UTC
  
  workflow_dispatch:
    inputs:
      introspection_depth:
        description: 'Depth of introspection'
        required: true
        default: 'full'
        type: choice
        options:
        - full
        - repos_only
        - org_only
        - graphql_schema

jobs:
  introspect-organization:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Generate GitHub App Token
      id: app-token
      uses: actions/create-github-app-token@v1
      with:
        app-id: ${{ vars.ORGIMA_APP_ID }}
        private-key: ${{ secrets.ORGIMA_APP_PRIVATE_KEY }}
        owner: org-regima
        
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests PyGithub gql[requests]
        
    - name: Create introspection scripts directory
      run: mkdir -p scripts outputs
      
    - name: Create REST API Introspection Script
      run: |
        cat > scripts/rest_introspection.py << 'SCRIPT'
        #!/usr/bin/env python3
        """
        OrgimA REST API Introspection Script
        Performs comprehensive organization introspection via GitHub REST API
        """
        import os
        import json
        import requests
        from datetime import datetime

        TOKEN = os.environ.get('GITHUB_TOKEN')
        ORG = 'org-regima'
        BASE_URL = 'https://api.github.com'
        HEADERS = {
            'Authorization': f'Bearer {TOKEN}',
            'Accept': 'application/vnd.github+json',
            'X-GitHub-Api-Version': '2022-11-28'
        }

        def api_get(endpoint):
            """Make authenticated GET request to GitHub API"""
            url = f"{BASE_URL}{endpoint}"
            response = requests.get(url, headers=HEADERS)
            response.raise_for_status()
            return response.json()

        def introspect_organization():
            """Get organization details"""
            print(f"Introspecting organization: {ORG}")
            org_data = api_get(f'/orgs/{ORG}')
            return {
                'login': org_data.get('login'),
                'name': org_data.get('name'),
                'id': org_data.get('id'),
                'node_id': org_data.get('node_id'),
                'description': org_data.get('description'),
                'created_at': org_data.get('created_at'),
                'updated_at': org_data.get('updated_at'),
                'public_repos': org_data.get('public_repos'),
                'total_private_repos': org_data.get('total_private_repos'),
                'owned_private_repos': org_data.get('owned_private_repos'),
                'members_count': org_data.get('members_count', 0),
                'plan': org_data.get('plan', {})
            }

        def introspect_repositories():
            """Get all repositories in the organization"""
            print("Introspecting repositories...")
            repos = api_get(f'/orgs/{ORG}/repos?per_page=100')
            return [{
                'name': r.get('name'),
                'full_name': r.get('full_name'),
                'id': r.get('id'),
                'node_id': r.get('node_id'),
                'description': r.get('description'),
                'private': r.get('private'),
                'default_branch': r.get('default_branch'),
                'language': r.get('language'),
                'topics': r.get('topics', []),
                'created_at': r.get('created_at'),
                'updated_at': r.get('updated_at'),
                'pushed_at': r.get('pushed_at'),
                'size': r.get('size'),
                'stargazers_count': r.get('stargazers_count'),
                'forks_count': r.get('forks_count'),
                'open_issues_count': r.get('open_issues_count'),
                'has_issues': r.get('has_issues'),
                'has_projects': r.get('has_projects'),
                'has_wiki': r.get('has_wiki'),
                'has_discussions': r.get('has_discussions'),
                'archived': r.get('archived'),
                'visibility': r.get('visibility')
            } for r in repos]

        def introspect_members():
            """Get organization members"""
            print("Introspecting members...")
            try:
                members = api_get(f'/orgs/{ORG}/members?per_page=100')
                return [{
                    'login': m.get('login'),
                    'id': m.get('id'),
                    'node_id': m.get('node_id'),
                    'type': m.get('type'),
                    'site_admin': m.get('site_admin')
                } for m in members]
            except Exception as e:
                print(f"Could not fetch members: {e}")
                return []

        def introspect_teams():
            """Get organization teams"""
            print("Introspecting teams...")
            try:
                teams = api_get(f'/orgs/{ORG}/teams?per_page=100')
                return [{
                    'name': t.get('name'),
                    'id': t.get('id'),
                    'node_id': t.get('node_id'),
                    'slug': t.get('slug'),
                    'description': t.get('description'),
                    'privacy': t.get('privacy'),
                    'permission': t.get('permission'),
                    'members_count': t.get('members_count'),
                    'repos_count': t.get('repos_count')
                } for t in teams]
            except Exception as e:
                print(f"Could not fetch teams: {e}")
                return []

        def introspect_hooks():
            """Get organization webhooks"""
            print("Introspecting webhooks...")
            try:
                hooks = api_get(f'/orgs/{ORG}/hooks?per_page=100')
                return [{
                    'id': h.get('id'),
                    'name': h.get('name'),
                    'active': h.get('active'),
                    'events': h.get('events', []),
                    'created_at': h.get('created_at'),
                    'updated_at': h.get('updated_at')
                } for h in hooks]
            except Exception as e:
                print(f"Could not fetch hooks: {e}")
                return []

        def main():
            introspection_data = {
                'metadata': {
                    'generated_at': datetime.utcnow().isoformat() + 'Z',
                    'generator': 'OrgimA REST Introspection',
                    'version': '1.0.0'
                },
                'organization': introspect_organization(),
                'repositories': introspect_repositories(),
                'members': introspect_members(),
                'teams': introspect_teams(),
                'webhooks': introspect_hooks()
            }
            
            # Write output
            os.makedirs('outputs', exist_ok=True)
            with open('outputs/rest_introspection.json', 'w') as f:
                json.dump(introspection_data, f, indent=2)
            
            print(f"\n=== Introspection Summary ===")
            print(f"Organization: {introspection_data['organization']['name']}")
            print(f"Repositories: {len(introspection_data['repositories'])}")
            print(f"Members: {len(introspection_data['members'])}")
            print(f"Teams: {len(introspection_data['teams'])}")
            print(f"Webhooks: {len(introspection_data['webhooks'])}")
            print(f"\nOutput saved to outputs/rest_introspection.json")

        if __name__ == '__main__':
            main()
        SCRIPT
        chmod +x scripts/rest_introspection.py
        
    - name: Create GraphQL Introspection Script
      run: |
        cat > scripts/graphql_introspection.py << 'SCRIPT'
        #!/usr/bin/env python3
        """
        OrgimA GraphQL API Introspection Script
        Performs GraphQL schema introspection and organization queries
        """
        import os
        import json
        import requests
        from datetime import datetime

        TOKEN = os.environ.get('GITHUB_TOKEN')
        GRAPHQL_URL = 'https://api.github.com/graphql'
        HEADERS = {
            'Authorization': f'Bearer {TOKEN}',
            'Content-Type': 'application/json'
        }

        def graphql_query(query, variables=None):
            """Execute GraphQL query"""
            payload = {'query': query}
            if variables:
                payload['variables'] = variables
            response = requests.post(GRAPHQL_URL, headers=HEADERS, json=payload)
            response.raise_for_status()
            return response.json()

        # Full GraphQL Schema Introspection Query
        FULL_INTROSPECTION_QUERY = '''
        query IntrospectionQuery {
          __schema {
            queryType { name }
            mutationType { name }
            subscriptionType { name }
            types {
              ...FullType
            }
            directives {
              name
              description
              locations
              args {
                ...InputValue
              }
            }
          }
        }

        fragment FullType on __Type {
          kind
          name
          description
          fields(includeDeprecated: true) {
            name
            description
            args {
              ...InputValue
            }
            type {
              ...TypeRef
            }
            isDeprecated
            deprecationReason
          }
          inputFields {
            ...InputValue
          }
          interfaces {
            ...TypeRef
          }
          enumValues(includeDeprecated: true) {
            name
            description
            isDeprecated
            deprecationReason
          }
          possibleTypes {
            ...TypeRef
          }
        }

        fragment InputValue on __InputValue {
          name
          description
          type {
            ...TypeRef
          }
          defaultValue
        }

        fragment TypeRef on __Type {
          kind
          name
          ofType {
            kind
            name
            ofType {
              kind
              name
              ofType {
                kind
                name
                ofType {
                  kind
                  name
                  ofType {
                    kind
                    name
                    ofType {
                      kind
                      name
                      ofType {
                        kind
                        name
                      }
                    }
                  }
                }
              }
            }
          }
        }
        '''

        # Organization introspection query
        ORG_INTROSPECTION_QUERY = '''
        query OrgIntrospection($org: String!) {
          organization(login: $org) {
            id
            login
            name
            description
            createdAt
            updatedAt
            isVerified
            location
            websiteUrl
            email
            membersWithRole {
              totalCount
            }
            teams {
              totalCount
            }
            repositories(first: 100) {
              totalCount
              nodes {
                id
                name
                description
                createdAt
                updatedAt
                pushedAt
                isPrivate
                isArchived
                isFork
                defaultBranchRef {
                  name
                }
                primaryLanguage {
                  name
                }
                languages(first: 10) {
                  nodes {
                    name
                  }
                }
                repositoryTopics(first: 10) {
                  nodes {
                    topic {
                      name
                    }
                  }
                }
                issues {
                  totalCount
                }
                pullRequests {
                  totalCount
                }
                discussions {
                  totalCount
                }
                releases {
                  totalCount
                }
                stargazerCount
                forkCount
              }
            }
            projects(first: 20) {
              totalCount
              nodes {
                id
                name
                body
                state
                createdAt
                updatedAt
              }
            }
            projectsV2(first: 20) {
              totalCount
              nodes {
                id
                title
                shortDescription
                public
                createdAt
                updatedAt
              }
            }
          }
        }
        '''

        def introspect_schema():
            """Perform full GraphQL schema introspection"""
            print("Performing GraphQL schema introspection...")
            result = graphql_query(FULL_INTROSPECTION_QUERY)
            return result.get('data', {}).get('__schema', {})

        def introspect_organization(org='org-regima'):
            """Introspect organization via GraphQL"""
            print(f"Introspecting organization {org} via GraphQL...")
            result = graphql_query(ORG_INTROSPECTION_QUERY, {'org': org})
            return result.get('data', {}).get('organization', {})

        def main():
            introspection_data = {
                'metadata': {
                    'generated_at': datetime.utcnow().isoformat() + 'Z',
                    'generator': 'OrgimA GraphQL Introspection',
                    'version': '1.0.0'
                },
                'schema': introspect_schema(),
                'organization': introspect_organization()
            }
            
            # Write outputs
            os.makedirs('outputs', exist_ok=True)
            
            # Full introspection data
            with open('outputs/graphql_introspection.json', 'w') as f:
                json.dump(introspection_data, f, indent=2)
            
            # Schema only (for tooling)
            with open('outputs/github_graphql_schema.json', 'w') as f:
                json.dump({'data': {'__schema': introspection_data['schema']}}, f, indent=2)
            
            # Summary
            schema = introspection_data['schema']
            org = introspection_data['organization']
            
            print(f"\n=== GraphQL Introspection Summary ===")
            print(f"Schema Types: {len(schema.get('types', []))}")
            print(f"Directives: {len(schema.get('directives', []))}")
            if org:
                print(f"Organization: {org.get('name', 'N/A')}")
                print(f"Repositories: {org.get('repositories', {}).get('totalCount', 0)}")
                print(f"Members: {org.get('membersWithRole', {}).get('totalCount', 0)}")
                print(f"Teams: {org.get('teams', {}).get('totalCount', 0)}")
            print(f"\nOutputs saved to outputs/")

        if __name__ == '__main__':
            main()
        SCRIPT
        chmod +x scripts/graphql_introspection.py
        
    - name: Run REST API Introspection
      if: ${{ github.event.inputs.introspection_depth != 'graphql_schema' }}
      env:
        GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
      run: python scripts/rest_introspection.py
      
    - name: Run GraphQL Introspection
      if: ${{ github.event.inputs.introspection_depth == 'full' || github.event.inputs.introspection_depth == 'graphql_schema' || github.event.inputs.introspection_depth == '' }}
      env:
        GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
      run: python scripts/graphql_introspection.py
      
    - name: Generate Introspection Report
      run: |
        cat > outputs/introspection_report.md << 'REPORT'
        # OrgimA Organization Introspection Report
        
        Generated: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
        
        ## Overview
        
        This report contains the results of automated introspection of the org-regima organization
        using the OrgimA Introspector GitHub App.
        
        ## Files Generated
        
        | File | Description |
        |------|-------------|
        | `rest_introspection.json` | Full REST API introspection data |
        | `graphql_introspection.json` | Full GraphQL introspection data |
        | `github_graphql_schema.json` | GitHub GraphQL schema (for tooling) |
        
        ## Usage
        
        These introspection files can be used for:
        - Generating type-safe API clients
        - Building organization dashboards
        - Automating repository management
        - Analyzing organizational structure
        - Pattern language implementation (Org-City)
        
        REPORT
        
    - name: Upload Introspection Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: orgima-introspection-${{ github.run_number }}
        path: outputs/
        retention-days: 90
        
    - name: Commit Introspection Data
      run: |
        git config user.name "OrgimA Introspector[bot]"
        git config user.email "orgima-introspector[bot]@users.noreply.github.com"
        git add outputs/ scripts/
        git diff --staged --quiet || git commit -m "chore: Update introspection data [skip ci]"
        git push || echo "No changes to push"
